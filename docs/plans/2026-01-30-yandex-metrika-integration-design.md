# Интеграция Яндекс.Метрики

**Дата:** 2026-01-30
**Статус:** Утверждено

## Цель

Встроить код Яндекс.Метрики (ID: 106538623) в веб-интерфейс для отслеживания посещений и поведения пользователей.

## Архитектура и размещение

Код Яндекс.Метрики встраивается в базовый шаблон `internal/web/templates/base.html`:

1. **JavaScript-блок** - в секцию `<head>` после инициализации темы, перед Tailwind CSS
2. **noscript-блок** - сразу после открывающего тега `<body>`

Такое размещение обеспечивает:
- Загрузку метрики на всех страницах сайта
- Раннюю инициализацию счётчика
- Корректную работу с SSR
- Fallback для пользователей без JavaScript

## Параметры метрики

- `ssr: true` - поддержка server-side rendering
- `webvisor: true` - запись сессий пользователей
- `clickmap: true` - тепловая карта кликов
- `accurateTrackBounce: true` - точный показатель отказов
- `trackLinks: true` - отслеживание внешних ссылок
- `ecommerce: "dataLayer"` - интеграция с e-commerce
- `referrer/url` - явная передача источника и URL

## Реализация

### Изменения

**Файл:** `internal/web/templates/base.html`

**Изменение 1:** После строки 29 (закрытие скрипта темы) добавить JavaScript-блок метрики

**Изменение 2:** После строки 120 (открывающий тег `<body>`) добавить noscript-блок

### Код без изменений

- ID метрики: `106538623`
- URL скрипта: `https://mc.yandex.ru/metrika/tag.js?id=106538623`
- URL пикселя: `https://mc.yandex.ru/watch/106538623`

## Тестирование

1. **DevTools Network:** проверить загрузку `tag.js?id=106538623`
2. **Console:** `typeof ym` должно вернуть `"function"`
3. **Яндекс.Метрика:** проверить раздел "Посетители онлайн" через 10-15 минут
4. **noscript:** отключить JS и проверить загрузку изображения `/watch/106538623`
5. **Все страницы:** проверить срабатывание на всех разделах сайта

## Управление

- Метрика всегда активна, без управления через конфигурацию
- Только стандартное отслеживание, без кастомных событий
