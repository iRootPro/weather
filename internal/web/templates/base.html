<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{block "title" .}}Метеостанция{{end}}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/static/favicon.png">

    <!-- PWA / Add to Home Screen -->
    <link rel="manifest" href="/static/manifest.json?v=4">
    <link rel="apple-touch-icon" href="/static/icon-180.png?v=4">
    <meta name="theme-color" content="#3b82f6" id="theme-color-meta">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Погода">

    <!-- Theme script (before CSS to prevent flash) -->
    <script>
        (function() {
            const stored = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const isDark = stored === 'dark' || (!stored && prefersDark);
            if (isDark) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>

    <!-- Tailwind CSS -->
    <script src="/static/js/vendor/tailwind.min.js"></script>

    <!-- HTMX -->
    <script src="/static/js/vendor/htmx.min.js"></script>

    <!-- Chart.js -->
    <script src="/static/js/vendor/chart.min.js"></script>

    <style>
        [x-cloak] { display: none !important; }

        /* Mobile touch improvements */
        a, button {
            -webkit-tap-highlight-color: rgba(59, 130, 246, 0.3);
            -webkit-touch-callout: none;
            touch-action: manipulation;
        }

        /* Mobile navigation - larger tap targets */
        @media (max-width: 640px) {
            nav a {
                min-width: 44px;
                min-height: 44px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
            }
        }

        /* Pull to refresh */
        .pull-to-refresh-indicator {
            position: fixed;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: top 0.3s ease;
            z-index: 9999;
        }

        .dark .pull-to-refresh-indicator {
            background: #1f2937;
        }

        .pull-to-refresh-indicator.visible {
            top: 20px;
        }

        .pull-to-refresh-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .dark .pull-to-refresh-spinner {
            border-color: #374151;
            border-top-color: #60a5fa;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen transition-colors duration-200">
    <!-- Pull to Refresh Indicator -->
    <div id="pull-to-refresh-indicator" class="pull-to-refresh-indicator">
        <div class="pull-to-refresh-spinner"></div>
    </div>

    <!-- Header (sticky) -->
    <header class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-50 transition-colors duration-200">
        <div class="max-w-7xl mx-auto px-4 py-3 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <svg class="w-7 h-7 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/>
                    </svg>
                    <h1 class="text-lg font-bold text-gray-900 dark:text-white hidden sm:block">Армавир</h1>
                </div>
                <!-- Desktop nav -->
                <nav class="hidden sm:flex space-x-2">
                    <a href="/" class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white px-3 py-2 rounded-md text-sm font-medium {{if eq .ActivePage "dashboard"}}bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white{{end}}">
                        Главная
                    </a>
                    <a href="/history" class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white px-3 py-2 rounded-md text-sm font-medium {{if eq .ActivePage "history"}}bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white{{end}}">
                        История
                    </a>
                    <a href="/records" class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white px-3 py-2 rounded-md text-sm font-medium {{if eq .ActivePage "records"}}bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white{{end}}">
                        Рекорды
                    </a>
                    <a href="/gallery" class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white px-3 py-2 rounded-md text-sm font-medium {{if eq .ActivePage "gallery"}}bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white{{end}}">
                        Галерея
                    </a>
                    <a href="/help" class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white px-3 py-2 rounded-md text-sm font-medium {{if eq .ActivePage "help"}}bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white{{end}}">
                        Справка
                    </a>
                </nav>
                <!-- Mobile nav -->
                <nav class="flex sm:hidden gap-1">
                        <a href="/" class="p-3 rounded-md text-sm font-medium {{if eq .ActivePage "dashboard"}}bg-blue-500 text-white{{else}}text-gray-600 dark:text-gray-300{{end}}">
                            <!-- Cloud with sun icon -->
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"/>
                                <circle cx="17" cy="7" r="2" stroke-width="1.5" opacity="0.6"/>
                                <path d="M17 5v-.5M19 7h.5M17 9v.5M15 7h-.5" stroke-width="1.5" opacity="0.6"/>
                            </svg>
                        </a>
                        <a href="/history" class="p-3 rounded-md text-sm font-medium {{if eq .ActivePage "history"}}bg-blue-500 text-white{{else}}text-gray-600 dark:text-gray-300{{end}}">
                            <!-- Trending up / Line chart icon -->
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                            </svg>
                        </a>
                        <a href="/records" class="p-3 rounded-md text-sm font-medium {{if eq .ActivePage "records"}}bg-blue-500 text-white{{else}}text-gray-600 dark:text-gray-300{{end}}">
                            <!-- Trophy icon -->
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/>
                            </svg>
                        </a>
                        <a href="/gallery" class="p-3 rounded-md text-sm font-medium {{if eq .ActivePage "gallery"}}bg-blue-500 text-white{{else}}text-gray-600 dark:text-gray-300{{end}}">
                            <!-- Camera icon -->
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                        </a>
                        <a href="/help" class="p-3 rounded-md text-sm font-medium {{if eq .ActivePage "help"}}bg-blue-500 text-white{{else}}text-gray-600 dark:text-gray-300{{end}}">
                            <!-- Info circle icon -->
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </a>
                    </nav>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6 sm:px-6 lg:px-8 mb-16">
        {{block "content" .}}{{end}}
    </main>

    <!-- Footer -->
    <footer class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 mt-auto transition-colors duration-200">
        <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-center sm:justify-between gap-3">
                <!-- Contact (Telegram only) -->
                <a href="https://t.me/iRootPro" target="_blank" rel="noopener noreferrer"
                   class="inline-flex items-center p-2 rounded-lg bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors"
                   title="Написать в Telegram">
                    <svg class="w-5 h-5 text-blue-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.894 8.221l-1.97 9.28c-.145.658-.537.818-1.084.508l-3-2.21-1.446 1.394c-.14.18-.357.295-.6.295-.002 0-.003 0-.005 0l.213-3.054 5.56-5.022c.24-.213-.054-.334-.373-.121l-6.869 4.326-2.96-.924c-.64-.203-.658-.64.135-.954l11.566-4.458c.538-.196 1.006.128.832.941z"/>
                    </svg>
                </a>

                <!-- Narodmon Status -->
                <div id="narodmon-status"
                     hx-get="/widgets/narodmon-status"
                     hx-trigger="load, every 60s"
                     hx-swap="innerHTML">
                </div>

                <!-- Theme Toggle -->
                <button onclick="toggleTheme()"
                        class="inline-flex items-center gap-2 p-2 sm:px-4 sm:py-2 rounded-lg bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
                        title="Переключить тему">
                    <!-- Sun icon (shown in dark mode) -->
                    <svg class="w-5 h-5 text-yellow-500 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
                    </svg>
                    <!-- Moon icon (shown in light mode) -->
                    <svg class="w-5 h-5 text-gray-700 dark:text-gray-300 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                    </svg>
                    <span class="hidden sm:inline text-sm font-medium text-gray-700 dark:text-gray-300">
                        <span class="hidden dark:inline">Светлая</span>
                        <span class="inline dark:hidden">Темная</span>
                    </span>
                </button>
            </div>
        </div>
    </footer>

    <script>
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');

            if (isDark) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                document.getElementById('theme-color-meta').content = '#3b82f6';
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                document.getElementById('theme-color-meta').content = '#1f2937';
            }

            // Dispatch event for charts to update
            window.dispatchEvent(new CustomEvent('themeChanged'));
        }

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            if (!localStorage.getItem('theme')) {
                if (e.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                window.dispatchEvent(new CustomEvent('themeChanged'));
            }
        });

        // Pull to Refresh
        (function() {
            let startY = 0;
            let currentY = 0;
            let pulling = false;
            const threshold = 80; // Порог для активации обновления
            const indicator = document.getElementById('pull-to-refresh-indicator');

            // Проверяем что мы на мобильном устройстве или touch-экране
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;

            if (!isTouchDevice) return;

            document.addEventListener('touchstart', (e) => {
                // Игнорируем тачи на header и footer (навигация)
                const target = e.target;
                if (target.closest('header') || target.closest('footer') || target.closest('nav') || target.closest('a') || target.closest('button')) {
                    return;
                }

                // Проверяем что страница прокручена в самый верх
                if (window.scrollY === 0) {
                    startY = e.touches[0].pageY;
                    pulling = true;
                }
            }, { passive: true });

            document.addEventListener('touchmove', (e) => {
                if (!pulling) return;

                currentY = e.touches[0].pageY;
                const pullDistance = currentY - startY;

                // Показываем индикатор только если тянем вниз
                if (pullDistance > 0 && pullDistance < threshold * 2) {
                    // Показываем индикатор пропорционально расстоянию
                    const progress = Math.min(pullDistance / threshold, 1);
                    indicator.style.top = `${-60 + (80 * progress)}px`;
                }
            }, { passive: true });

            document.addEventListener('touchend', async (e) => {
                if (!pulling) return;

                const pullDistance = currentY - startY;
                pulling = false;

                // Если потянули достаточно далеко - обновляем
                if (pullDistance > threshold) {
                    // Показываем индикатор загрузки
                    indicator.classList.add('visible');

                    // Обновляем все HTMX элементы на странице
                    const htmxElements = document.querySelectorAll('[hx-get]');
                    let refreshPromises = [];

                    htmxElements.forEach(el => {
                        const url = el.getAttribute('hx-get');
                        const swap = el.getAttribute('hx-swap') || 'innerHTML';

                        if (url) {
                            // Используем HTMX API для загрузки данных
                            const promise = new Promise((resolve) => {
                                el.addEventListener('htmx:afterSwap', resolve, { once: true });
                                htmx.ajax('GET', url, { target: el, swap: swap });
                            });
                            refreshPromises.push(promise);
                        }
                    });

                    // Ждем завершения всех обновлений или минимум 800мс
                    await Promise.race([
                        Promise.all(refreshPromises),
                        new Promise(resolve => setTimeout(resolve, 800))
                    ]);

                    // Скрываем индикатор
                    indicator.classList.remove('visible');
                } else {
                    // Скрываем индикатор с анимацией
                    indicator.style.top = '-60px';
                }

                // Сбрасываем позицию
                setTimeout(() => {
                    indicator.style.top = '-60px';
                }, 300);
            }, { passive: true });
        })();
    </script>

    {{block "scripts" .}}{{end}}
</body>
</html>
