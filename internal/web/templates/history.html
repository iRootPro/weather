{{template "base.html" .}}

{{define "title"}}История - Метеостанция{{end}}

{{define "content"}}
<div class="space-y-6">
  <!-- Date Range Selector -->
  <div class="bg-white rounded-lg shadow p-4">
    <div class="flex flex-wrap items-center gap-4">
      <div>
        <label for="dateFrom" class="block text-sm font-medium text-gray-700">От</label>
        <input type="date" id="dateFrom"
          class="mt-1 block rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
      </div>
      <div>
        <label for="dateTo" class="block text-sm font-medium text-gray-700">До</label>
        <input type="date" id="dateTo"
          class="mt-1 block rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
      </div>
      <div>
        <label for="interval" class="block text-sm font-medium text-gray-700">Интервал</label>
        <select id="interval"
          class="mt-1 block rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
          <option value="5m">5 минут</option>
          <option value="15m">15 минут</option>
          <option value="1h" selected>1 час</option>
          <option value="1d">1 день</option>
        </select>
      </div>
      <div class="flex items-end">
        <button onclick="loadHistoryData()"
          class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
          Загрузить
        </button>
      </div>
    </div>
  </div>

  <!-- Period Stats -->
  <div id="period-stats" hx-get="/widgets/stats?period=week" hx-trigger="load" hx-swap="innerHTML">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="animate-pulse bg-white rounded-lg shadow p-4">
        <div class="h-6 bg-gray-200 rounded w-1/2 mb-2"></div>
        <div class="h-10 bg-gray-200 rounded"></div>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="bg-white rounded-lg shadow p-6">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Графики</h2>
    <div class="space-y-8">
      <div class="h-48">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Температура</h3>
        <canvas id="historyTempChart"></canvas>
      </div>
      <div class="h-48">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Влажность</h3>
        <canvas id="historyHumidityChart"></canvas>
      </div>
      <div class="h-48">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Давление</h3>
        <canvas id="historyPressureChart"></canvas>
      </div>
      <div class="h-48">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Ветер</h3>
        <canvas id="historyWindChart"></canvas>
      </div>
      <div class="h-48">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Осадки</h3>
        <canvas id="historyRainChart"></canvas>
      </div>
      <div class="h-48">
        <h3 class="text-sm font-medium text-gray-700 mb-2">Освещённость</h3>
        <canvas id="historySolarChart"></canvas>
      </div>
    </div>
  </div>
</div>
{{end}}

{{define "scripts"}}
<script src="/static/js/charts.js"></script>
<script>
  let historyCharts = {};

  document.addEventListener('DOMContentLoaded', function () {
    // Set default dates
    const today = new Date();
    const weekAgo = new Date(today);
    weekAgo.setDate(weekAgo.getDate() - 7);

    document.getElementById('dateTo').value = today.toISOString().split('T')[0];
    document.getElementById('dateFrom').value = weekAgo.toISOString().split('T')[0];

    initHistoryCharts();
    loadHistoryData();
  });

  function initHistoryCharts() {
    const commonOptions = {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {display: false}
      },
      scales: {
        x: {
          grid: {display: false},
          ticks: {maxRotation: 0, autoSkip: true, maxTicksLimit: 8, font: {size: 10}}
        },
        y: {
          grid: {color: '#f3f4f6'},
          ticks: {font: {size: 10}}
        }
      },
      elements: {
        point: {radius: 1, hoverRadius: 4},
        line: {tension: 0.3, borderWidth: 2}
      }
    };

    historyCharts.temp = new Chart(document.getElementById('historyTempChart'), {
      type: 'line',
      data: {labels: [], datasets: [{label: 'Температура', data: [], borderColor: '#f97316', backgroundColor: 'rgba(249, 115, 22, 0.1)', fill: true}]},
      options: {
        ...commonOptions,
        plugins: {...commonOptions.plugins, tooltip: {callbacks: {label: (ctx) => ctx.raw.toFixed(1) + '°C'}}},
        scales: {...commonOptions.scales, y: {...commonOptions.scales.y, ticks: {callback: (v) => v.toFixed(0) + '°', font: {size: 10}}}}
      }
    });

    historyCharts.humidity = new Chart(document.getElementById('historyHumidityChart'), {
      type: 'line',
      data: {labels: [], datasets: [{label: 'Влажность', data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true}]},
      options: {
        ...commonOptions,
        plugins: {...commonOptions.plugins, tooltip: {callbacks: {label: (ctx) => Math.round(ctx.raw) + '%'}}},
        scales: {...commonOptions.scales, y: {...commonOptions.scales.y, min: 0, max: 100, ticks: {callback: (v) => v + '%', font: {size: 10}}}}
      }
    });

    historyCharts.pressure = new Chart(document.getElementById('historyPressureChart'), {
      type: 'line',
      data: {labels: [], datasets: [{label: 'Давление', data: [], borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.1)', fill: true}]},
      options: {
        ...commonOptions,
        plugins: {...commonOptions.plugins, tooltip: {callbacks: {label: (ctx) => ctx.raw.toFixed(1) + ' мм'}}},
        scales: {...commonOptions.scales, y: {...commonOptions.scales.y, ticks: {callback: (v) => v.toFixed(1) + ' мм', font: {size: 10}}}}
      }
    });

    historyCharts.wind = new Chart(document.getElementById('historyWindChart'), {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          {label: 'Скорость', data: [], borderColor: '#14b8a6', backgroundColor: 'rgba(20, 184, 166, 0.1)', fill: true},
          {label: 'Порывы', data: [], borderColor: '#f43f5e', backgroundColor: 'transparent', borderDash: [5, 5]}
        ]
      },
      options: {
        ...commonOptions,
        plugins: {
          ...commonOptions.plugins, legend: {display: true, position: 'top', labels: {font: {size: 10}, usePointStyle: true, pointStyle: 'line'}},
          tooltip: {callbacks: {label: (ctx) => ctx.dataset.label + ': ' + ctx.raw.toFixed(1) + ' м/с'}}
        },
        scales: {...commonOptions.scales, y: {...commonOptions.scales.y, min: 0, ticks: {callback: (v) => v.toFixed(1) + ' м/с', font: {size: 10}}}}
      }
    });

    historyCharts.rain = new Chart(document.getElementById('historyRainChart'), {
      type: 'bar',
      data: {labels: [], datasets: [{label: 'Осадки', data: [], backgroundColor: 'rgba(6, 182, 212, 0.7)', borderColor: '#06b6d4', borderWidth: 1}]},
      options: {
        ...commonOptions,
        plugins: {...commonOptions.plugins, tooltip: {callbacks: {label: (ctx) => ctx.raw.toFixed(1) + ' мм'}}},
        scales: {...commonOptions.scales, y: {...commonOptions.scales.y, min: 0, ticks: {callback: (v) => v.toFixed(1) + ' мм', font: {size: 10}}}}
      }
    });

    historyCharts.solar = new Chart(document.getElementById('historySolarChart'), {
      type: 'line',
      data: {labels: [], datasets: [{label: 'Освещённость', data: [], borderColor: '#eab308', backgroundColor: 'rgba(234, 179, 8, 0.1)', fill: true}]},
      options: {
        ...commonOptions,
        plugins: {...commonOptions.plugins, tooltip: {callbacks: {label: (ctx) => Math.round(ctx.raw * 120) + ' люкс'}}},
        scales: {...commonOptions.scales, y: {...commonOptions.scales.y, min: 0, ticks: {callback: (v) => Math.round(v * 120) + ' лк', font: {size: 10}}}}
      }
    });
  }

  async function loadHistoryData() {
    const from = document.getElementById('dateFrom').value;
    const to = document.getElementById('dateTo').value;
    const interval = document.getElementById('interval').value;

    const response = await fetch(`/api/weather/chart?from=${from}&to=${to}&interval=${interval}&fields=temp_outdoor,humidity_outdoor,pressure_relative,wind_speed,wind_gust,rain_rate,solar_radiation`);
    const data = await response.json();

    historyCharts.temp.data.labels = data.labels;
    historyCharts.temp.data.datasets[0].data = data.datasets.temp_outdoor;
    historyCharts.temp.update();

    historyCharts.humidity.data.labels = data.labels;
    historyCharts.humidity.data.datasets[0].data = data.datasets.humidity_outdoor;
    historyCharts.humidity.update();

    historyCharts.pressure.data.labels = data.labels;
    historyCharts.pressure.data.datasets[0].data = data.datasets.pressure_relative;
    historyCharts.pressure.update();

    historyCharts.wind.data.labels = data.labels;
    historyCharts.wind.data.datasets[0].data = data.datasets.wind_speed;
    historyCharts.wind.data.datasets[1].data = data.datasets.wind_gust;
    historyCharts.wind.update();

    historyCharts.rain.data.labels = data.labels;
    historyCharts.rain.data.datasets[0].data = data.datasets.rain_rate;
    historyCharts.rain.update();

    historyCharts.solar.data.labels = data.labels;
    historyCharts.solar.data.datasets[0].data = data.datasets.solar_radiation;
    historyCharts.solar.update();
  }
</script>
{{end}}
